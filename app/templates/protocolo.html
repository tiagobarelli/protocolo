{% extends "base.html" %}
{% block title %}Protocolo — Detalhe{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/protocolo.css') }}">
{% endblock %}

{% block content %}
<button type="button" class="hamburger-btn" onclick="toggleSidebar()">
  <i class="ph ph-list"></i>
</button>
<div class="sidebar-overlay"></div>

<div class="app-layout">
  {% include "partials/sidebar.html" %}

  <main class="main-content">
<div class="overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<div class="container">
  <!-- Cabeçalho -->
  <div class="proto-header">
    <h1 id="protoNumero">Carregando...</h1>
    <span class="status-badge" id="protoBadge"></span>
    <select id="statusSelect" class="status-select" style="display:none;">
      <option value="3064">Em andamento</option>
      <option value="3065">Finalizado</option>
      <option value="3066">Cancelado</option>
    </select>
  </div>

  <!-- Justificativa de Cancelamento -->
  <div class="card justificativa-card" id="justificativaCard" style="display:none;">
    <div class="card-title"><i class="ph ph-warning-circle"></i> Justificativa do Cancelamento</div>
    <div id="justificativaReadonly" class="justificativa-texto" style="display:none;"></div>
    <div id="justificativaEditavel" style="display:none;">
      <textarea id="justificativaTexto" class="justificativa-textarea" placeholder="Descreva o motivo do cancelamento..." rows="3"></textarea>
      <div class="btn-row">
        <button type="button" class="btn btn-danger" id="btnConfirmarCancelamento">
          <i class="ph ph-prohibit"></i> Confirmar Cancelamento
        </button>
        <button type="button" class="btn btn-outline btn-sm" id="btnCancelarCancelamento">
          Voltar
        </button>
        <div class="msg-box" id="justificativaMsg"></div>
      </div>
    </div>
  </div>

  <!-- Barra de ações -->
  <div class="action-bar">
    <a href="{{ url_for('main.protocolo_imprimir', protocolo_id=protocolo_id) }}" class="btn btn-outline">
      <i class="ph ph-printer"></i> Imprimir Comprovante
    </a>
  </div>

  <!-- Dados do Protocolo -->
  <div class="card">
    <div class="card-title"><i class="ph ph-file-text"></i> Informações do Protocolo</div>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">Interessado</div>
        <div class="info-value destaque" id="infoInteressado">—</div>
      </div>
      <div class="info-item">
        <div class="info-label">Documento (CPF/CNPJ)</div>
        <div class="info-value" id="infoDocumento">—</div>
      </div>
      <div id="alertaProtocolo" class="alerta-inline-proto" style="display:none; grid-column: 1 / -1;"></div>
      <div class="info-item" id="infoAdvogadoRow" style="display: none;">
        <div class="info-label">Advogado</div>
        <div class="info-value" id="infoAdvogado">—</div>
      </div>
      <div class="info-item" id="infoOabRow" style="display: none;">
        <div class="info-label">OAB</div>
        <div class="info-value" id="infoOab">—</div>
      </div>
      <div class="info-item">
        <div class="info-label">Serviço</div>
        <div class="info-value" id="infoServico">—</div>
      </div>
      <div class="info-item info-item-editable" id="infoResponsavelRow">
        <div class="info-label">Responsável</div>
        <div class="info-value" id="infoResponsavel">—</div>
        <div class="inline-edit" id="infoResponsavelEdit" style="display:none;">
          <select id="editResponsavelSelect" class="inline-input"></select>
          <button type="button" class="btn-inline-save" id="btnSalvarResponsavel" title="Salvar">
            <i class="ph ph-check"></i>
          </button>
          <button type="button" class="btn-inline-cancel" id="btnCancelarResponsavel" title="Cancelar">
            <i class="ph ph-x"></i>
          </button>
        </div>
        <button type="button" class="btn-inline-edit" id="btnEditResponsavel" style="display:none;" title="Editar">
          <i class="ph ph-pencil-simple"></i>
        </button>
      </div>
      <div class="info-item" id="infoCriadoPorRow" style="display: none;">
        <div class="info-label">Criado por</div>
        <div class="info-value" id="infoCriadoPor">—</div>
      </div>
      <div class="info-item">
        <div class="info-label">Data de Entrada</div>
        <div class="info-value" id="infoDataEntrada">—</div>
      </div>
      <div class="info-item info-item-editable" id="infoAgendadoRow">
        <div class="info-label">Agendado para</div>
        <div class="info-value" id="infoAgendado">—</div>
        <div class="inline-edit" id="infoAgendadoEdit" style="display:none;">
          <input type="date" id="editAgendadoInput" class="inline-input">
          <button type="button" class="btn-inline-save" id="btnSalvarAgendado" title="Salvar">
            <i class="ph ph-check"></i>
          </button>
          <button type="button" class="btn-inline-cancel" id="btnCancelarAgendado" title="Cancelar">
            <i class="ph ph-x"></i>
          </button>
        </div>
        <button type="button" class="btn-inline-edit" id="btnEditAgendado" style="display:none;" title="Editar">
          <i class="ph ph-pencil-simple"></i>
        </button>
      </div>
      <div class="info-item" id="infoDepositoRow" style="display: none;">
        <div class="info-label">Depósito Prévio</div>
        <div class="info-value" id="infoDeposito">—</div>
      </div>
      <div class="info-item" id="infoTelefoneRow" style="display: none;">
        <div class="info-label">Telefone</div>
        <div class="info-value" id="infoTelefone">—</div>
      </div>
      <div class="info-item" id="infoEmailRow" style="display: none;">
        <div class="info-label">E-mail</div>
        <div class="info-value" id="infoEmail">—</div>
      </div>
    </div>
  </div>

  <!-- Detalhamentos (markdown) -->
  <div class="card" id="infoDetalhamentosRow" style="display: none;">
    <div class="card-title"><i class="ph ph-text-align-left"></i> Detalhamentos</div>
    <div class="detalhamentos-content" id="infoDetalhamentos"></div>
  </div>

  <!-- Arquivos Anexados -->
  <div class="card">
    <div class="card-title"><i class="ph ph-paperclip"></i> Arquivos Anexados</div>

    <!-- Área de upload -->
    <div class="upload-area">
      <input type="file" id="fileInput" style="display: none;"
             accept=".doc,.docx,.odt,.pdf,.jpg,.png,.txt,.md,.xls">
      <button type="button" class="btn btn-outline" id="btnSelectFile">
        <i class="ph ph-upload-simple"></i> Selecionar Arquivo
      </button>
      <span class="upload-hint">Formatos: DOC, DOCX, ODT, PDF, JPG, PNG, TXT, MD, XLS — Máx: 20 MB</span>
      <div class="msg-box" id="uploadMsg"></div>
    </div>

    <!-- Lista de arquivos -->
    <div id="filesList" class="files-list">
      <div class="files-empty">Nenhum arquivo anexado.</div>
    </div>
  </div>

  <!-- Histórico de Alterações -->
  <div class="card log-card" id="logCardProto" style="display:none;">
    <div class="card-title"><i class="ph ph-clock-counter-clockwise"></i> Histórico de Alterações</div>
    <div id="logContentProto" class="log-texto"></div>
  </div>

  <!-- Andamento (editável) -->
  <div class="card andamento-card">
    <div class="card-title"><i class="ph ph-pencil-line"></i> Andamento</div>
    <textarea id="andamentoTexto" placeholder="Registre aqui o andamento do protocolo..."></textarea>
    <div class="btn-row">
      <button type="button" class="btn btn-primary" id="btnSalvarAndamento">
        <i class="ph ph-floppy-disk"></i> Salvar Andamento
      </button>
      <div class="msg-box" id="andamentoMsg"></div>
    </div>
  </div>
</div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/marked/marked.umd.js') }}"></script>
<script>
  window.PROTOCOLO_ID = {{ protocolo_id }};
  window.CURRENT_USER = {
    id: {{ current_user.id }},
    nome: "{{ current_user.nome }}",
    perfil: "{{ current_user.perfil }}"
  };
</script>
<script src="{{ url_for('static', filename='js/protocolo.js') }}"></script>
{% endblock %}
